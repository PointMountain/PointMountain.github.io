<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>手写loader | Ming</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <meta name="description" content="学习文档">
    <link rel="preload" href="/mo/assets/css/0.styles.4ab656b6.css" as="style"><link rel="preload" href="/mo/assets/js/app.c4ede032.js" as="script"><link rel="preload" href="/mo/assets/js/2.3f89376a.js" as="script"><link rel="preload" href="/mo/assets/js/32.5a8bac30.js" as="script"><link rel="prefetch" href="/mo/assets/js/10.22a5a8df.js"><link rel="prefetch" href="/mo/assets/js/11.e4d5d531.js"><link rel="prefetch" href="/mo/assets/js/12.371abcad.js"><link rel="prefetch" href="/mo/assets/js/13.d0f93901.js"><link rel="prefetch" href="/mo/assets/js/14.b9523e8a.js"><link rel="prefetch" href="/mo/assets/js/15.f64a791f.js"><link rel="prefetch" href="/mo/assets/js/16.c51bc63e.js"><link rel="prefetch" href="/mo/assets/js/17.195e341e.js"><link rel="prefetch" href="/mo/assets/js/18.b3e7b43d.js"><link rel="prefetch" href="/mo/assets/js/19.bdd73e34.js"><link rel="prefetch" href="/mo/assets/js/20.99179d39.js"><link rel="prefetch" href="/mo/assets/js/21.66166324.js"><link rel="prefetch" href="/mo/assets/js/22.b661c0ce.js"><link rel="prefetch" href="/mo/assets/js/23.89c799b3.js"><link rel="prefetch" href="/mo/assets/js/24.44b1ae75.js"><link rel="prefetch" href="/mo/assets/js/25.26c4352f.js"><link rel="prefetch" href="/mo/assets/js/26.8fcc9f14.js"><link rel="prefetch" href="/mo/assets/js/27.4548d462.js"><link rel="prefetch" href="/mo/assets/js/28.62766de6.js"><link rel="prefetch" href="/mo/assets/js/29.4fea2295.js"><link rel="prefetch" href="/mo/assets/js/3.2e9a1832.js"><link rel="prefetch" href="/mo/assets/js/30.d3717f55.js"><link rel="prefetch" href="/mo/assets/js/31.99f7fc49.js"><link rel="prefetch" href="/mo/assets/js/33.5eae774a.js"><link rel="prefetch" href="/mo/assets/js/4.e00b4962.js"><link rel="prefetch" href="/mo/assets/js/5.2a0d6252.js"><link rel="prefetch" href="/mo/assets/js/6.275bec27.js"><link rel="prefetch" href="/mo/assets/js/7.afe7d926.js"><link rel="prefetch" href="/mo/assets/js/8.ee4851bd.js"><link rel="prefetch" href="/mo/assets/js/9.6491c6e0.js">
    <link rel="stylesheet" href="/mo/assets/css/0.styles.4ab656b6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mo/" class="home-link router-link-active"><!----> <span class="site-name">Ming</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mo/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mo/Javascript/base.html" class="nav-link">
  Javascript基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue" class="dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mo/Vue/Vue-base.html" class="nav-link">
  Vue基础使用
</a></li><li class="dropdown-item"><!----> <a href="/mo/Vue/Vue-advanced.html" class="nav-link">
  Vue高级特性
</a></li><li class="dropdown-item"><!----> <a href="/mo/Vue/Vuex.html" class="nav-link">
  Vuex
</a></li><li class="dropdown-item"><!----> <a href="/mo/Vue/Vue-router.html" class="nav-link">
  Vue-router
</a></li><li class="dropdown-item"><!----> <a href="/mo/Vue/Vue-principle.html" class="nav-link">
  Vue原理
</a></li><li class="dropdown-item"><!----> <a href="/mo/Vue/Vue-code.html" class="nav-link">
  Vue源码解析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React" class="dropdown-title"><span class="title">React</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mo/React/React-State.html" class="nav-link">
  React State
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-Props.html" class="nav-link">
  React Props
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-Refs.html" class="nav-link">
  React Refs
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-Router.html" class="nav-link">
  React Router
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-Redux.html" class="nav-link">
  React Redux Router
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-Extension.html" class="nav-link">
  React Extension
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-cli-proxy.html" class="nav-link">
  React脚手架配置代理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack" class="dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mo/webpack/Base.html" class="nav-link">
  基础学习
</a></li><li class="dropdown-item"><!----> <a href="/mo/webpack/Principle.html" class="nav-link router-link-exact-active router-link-active">
  原理学习
</a></li></ul></div></div><div class="nav-item"><a href="/mo/Typescript/" class="nav-link">
  Typescript
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杂记" class="dropdown-title"><span class="title">杂记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mo/others/Base.html" class="nav-link">
  基础学习
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/Network.html" class="nav-link">
  网络学习
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/SomeInterview.html" class="nav-link">
  面试整理
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/Connect.html" class="nav-link">
  网络连接方式
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/Monitor.html" class="nav-link">
  前端监控
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/Performance.html" class="nav-link">
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/SomeJS.html" class="nav-link">
  随手写代码
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/myPromise.html" class="nav-link">
  Promise代码
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/PointMountain/mo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GayHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mo/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/mo/Javascript/base.html" class="nav-link">
  Javascript基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vue" class="dropdown-title"><span class="title">Vue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mo/Vue/Vue-base.html" class="nav-link">
  Vue基础使用
</a></li><li class="dropdown-item"><!----> <a href="/mo/Vue/Vue-advanced.html" class="nav-link">
  Vue高级特性
</a></li><li class="dropdown-item"><!----> <a href="/mo/Vue/Vuex.html" class="nav-link">
  Vuex
</a></li><li class="dropdown-item"><!----> <a href="/mo/Vue/Vue-router.html" class="nav-link">
  Vue-router
</a></li><li class="dropdown-item"><!----> <a href="/mo/Vue/Vue-principle.html" class="nav-link">
  Vue原理
</a></li><li class="dropdown-item"><!----> <a href="/mo/Vue/Vue-code.html" class="nav-link">
  Vue源码解析
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="React" class="dropdown-title"><span class="title">React</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mo/React/React-State.html" class="nav-link">
  React State
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-Props.html" class="nav-link">
  React Props
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-Refs.html" class="nav-link">
  React Refs
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-Router.html" class="nav-link">
  React Router
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-Redux.html" class="nav-link">
  React Redux Router
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-Extension.html" class="nav-link">
  React Extension
</a></li><li class="dropdown-item"><!----> <a href="/mo/React/React-cli-proxy.html" class="nav-link">
  React脚手架配置代理
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="webpack" class="dropdown-title"><span class="title">webpack</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mo/webpack/Base.html" class="nav-link">
  基础学习
</a></li><li class="dropdown-item"><!----> <a href="/mo/webpack/Principle.html" class="nav-link router-link-exact-active router-link-active">
  原理学习
</a></li></ul></div></div><div class="nav-item"><a href="/mo/Typescript/" class="nav-link">
  Typescript
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="杂记" class="dropdown-title"><span class="title">杂记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mo/others/Base.html" class="nav-link">
  基础学习
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/Network.html" class="nav-link">
  网络学习
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/SomeInterview.html" class="nav-link">
  面试整理
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/Connect.html" class="nav-link">
  网络连接方式
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/Monitor.html" class="nav-link">
  前端监控
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/Performance.html" class="nav-link">
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/SomeJS.html" class="nav-link">
  随手写代码
</a></li><li class="dropdown-item"><!----> <a href="/mo/others/myPromise.html" class="nav-link">
  Promise代码
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/PointMountain/mo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GayHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/mo/webpack/Base.html" class="sidebar-link">webpack</a></li><li><a href="/mo/webpack/Principle.html" class="active sidebar-link">原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mo/webpack/Principle.html#手写loader" class="sidebar-link">手写loader</a></li><li class="sidebar-sub-header"><a href="/mo/webpack/Principle.html#手写plugin" class="sidebar-link">手写plugin</a></li><li class="sidebar-sub-header"><a href="/mo/webpack/Principle.html#工作原理剖析" class="sidebar-link">工作原理剖析</a></li><li class="sidebar-sub-header"><a href="/mo/webpack/Principle.html#webpack自动编译" class="sidebar-link">Webpack自动编译</a></li><li class="sidebar-sub-header"><a href="/mo/webpack/Principle.html#配置webpack-sourcemap" class="sidebar-link">配置Webpack SourceMap</a></li><li class="sidebar-sub-header"><a href="/mo/webpack/Principle.html#webpack高级特性" class="sidebar-link">Webpack高级特性</a></li><li class="sidebar-sub-header"><a href="/mo/webpack/Principle.html#优化webpack的构建速度和打包结果" class="sidebar-link">优化Webpack的构建速度和打包结果</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="手写loader"><a href="#手写loader" class="header-anchor">#</a> 手写loader</h2> <p>loader 只是一个导出为函数的 JavaScript 模块。loader runner 会调用这个函数，然后把上一个 loader 产生的结果或者资源文件(resource file)传入进去。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 导出的函数不能为箭头函数，因为loader编写过程中会经常使用到this访问选项和其他方法</span>
<span class="token comment">/**
callback方法内部传参
this.callback(
  err: Error | null,
  content: string | Buffer,
  sourceMap?: SourceMap,
  meta?: any
)
*/</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> sourceMap<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 同步loader直接return返回</span>
  <span class="token keyword">return</span> <span class="token function">someSyncOperation</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
  <span class="token comment">// 2. 同步loader通过this.callback返回</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">someSyncOperation</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> sourceMap<span class="token punctuation">,</span> meta<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token comment">// 当调用 callback() 时总是返回 undefined</span>
  <span class="token comment">// 3. 异步loader通过使用this.async()获取callback函数</span>
  <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">someAsyncOperation</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> result<span class="token punctuation">,</span> sourceMap<span class="token punctuation">,</span> meta<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="手写plugin"><a href="#手写plugin" class="header-anchor">#</a> 手写plugin</h2> <p>Webpack 工作流程中最核心的两个模块：Compiler 和 Compilation 都扩展自 Tapable 类，用于实现工作流程中的生命周期划分，以便在不同的生命周期节点上注册和调用插件。其中所暴露出来的生命周期节点称为Hook（俗称钩子）。
Compiler 和 Compilation 是Plugin 和 Webpack 之间的桥梁</p> <ul><li>Compiler 对象包含了 Webpack 环境所有的的配置信息，包含 options，loaders，plugins 这些信息，这个对象在 Webpack 启动时候被实例化，它是全局唯一的，可以简单地把它理解为 Webpack 实例；</li> <li>Compilation 对象包含了当前的模块资源、编译生成资源、变化的文件等。当 Webpack 以开发模式运行时，每当检测到一个文件变化，一次新的 Compilation 将被创建。Compilation 对象也提供了很多事件回调供插件做扩展。通过 Compilation 也能读取到 Compiler 对象。
plugin有两种 一种是返回一个执行函数 一种是返回一个带有apply方法的对象</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 返回一个执行函数</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// some operation</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 返回一个包含 apply 方法的 JavaScript 对象</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">TestPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过在compiler实例上的hooks找到make钩子，然后通过tap方法注册同步事件</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'TestPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tap make'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 通过在compiler实例上的hooks找到make钩子，然后通过tapAsync方法注册异步事件</span>
    <span class="token comment">// 需要通过使用回调中的callback告知Webpack异步逻辑执行完毕</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'TestPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tapAsync make'</span><span class="token punctuation">)</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 通过在compiler实例上的hooks找到make钩子，然后通过tapPromise方法注册异步事件</span>
    <span class="token comment">// 结果需要返回promise</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'TestPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tapPromise make'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 回调也可以用async/await</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'TestPlugin'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tapPromise make'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'TestPlugin'</span><span class="token punctuation">,</span> <span class="token parameter">compilation</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// compilation实例上也有钩子可以注册事件</span>
      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>buildModule<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'CalculateTimePlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Compilation Hook buildModule'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="工作原理剖析"><a href="#工作原理剖析" class="header-anchor">#</a> 工作原理剖析</h2> <ol><li>Webpack CLI启动打包流程</li> <li>载入Webpack核心模块，创建Compiler对象</li> <li>使用Compiler对象开始编译整个项目</li> <li>从入口文件开始，解析模块依赖，形成依赖关系树</li> <li>递归依赖树，将每个模块交给对应的Loader处理</li> <li>合并Loader处理完的结果，将打包结果输出到dist目录</li></ol> <h2 id="webpack自动编译"><a href="#webpack自动编译" class="header-anchor">#</a> Webpack自动编译</h2> <p>使用<code>npm i webpack-dev-server -D</code>或者<code>yarn add webpack-dev-server --dev</code>安装<code>webpack-dev-server</code>模块，之后可以直接在控制台
输入<code>node_modules/.bin/webpack-dev-server</code>直接启动项目，其内部会启动一个 HTTP Server，为打包的结果提供静态文件服务，并且自动使用 Webpack 打包我们的应用，然后监听源代码的变化，一旦文件发生变化，为了提高工作速率，它并没有将打包结果写入到磁盘中，而是暂时存放在内存中，内部的 HTTP Server 也是从内存中读取这些文件的。这样一来，就会减少很多不必要的磁盘读写操作，大大提高了整体的构建效率。<strong>使用webpack-dev-server时一定要注意是否和webpack，webpack-cli版本是否匹配，不匹配会报错</strong></p> <p>安装之后可以在<code>webpack.config.js</code>中进行配置</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 指定的额外静态资源访问</span>
    contentBase<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    compress<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 在服务器启动后打开浏览器</span>
    port<span class="token operator">:</span> <span class="token number">9000</span><span class="token punctuation">,</span>
    proxy<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'/api'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        target<span class="token operator">:</span> <span class="token string">'https://api.github.com'</span><span class="token punctuation">,</span>
        pathRewrite<span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">'^/api'</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token comment">// 替换掉代理地址中的/api</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        changeOrigin<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 确保请求Github的主机名就是https://api.github.com</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 开启HMR特性，如果资源不支持HMR会fallback到live reloading</span>
    hot<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token comment">// 只使用HMR，不会fallback到live reloading</span>
    <span class="token comment">// hotOnly: true</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 详细配置文档：https://webpack.js.org/configuration/dev-server/</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="hmr（hot-module-replacement）模块热替换"><a href="#hmr（hot-module-replacement）模块热替换" class="header-anchor">#</a> HMR（Hot Module Replacement）模块热替换</h3> <p><code>webpack-dev-server</code>会自动刷新导致页面原有状态丢失，因此需要模块热替换在运行过程中的直接替换。
需要配置</p> <ol><li>devServer配置中使用<code>hot: true</code></li> <li>plugins中使用webpack自带的热替换模块<code>new webpack.HotModuleReplacementPlugin()</code>
配置好之后 对引用样式的修改会直接触发热替换，但是对JavaScript的修改还是会触发页面刷新，因为代码比较复杂，不能直接替换，
因此对JavaScript的代码需要额外配置</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// module.hot是HotModuleReplacementPlugin插件对module注入的对象</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">'文件地址'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 需要的热更新的操作</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'file has updated'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="配置webpack-sourcemap"><a href="#配置webpack-sourcemap" class="header-anchor">#</a> 配置Webpack SourceMap</h2> <blockquote><p>devtool should match pattern &quot;^(inline-|hidden-|eval-)?(nosources-)?(cheap-(module-)?)?source-map$&quot;</p></blockquote> <h3 id="eval模式"><a href="#eval模式" class="header-anchor">#</a> Eval模式</h3> <p>eval其实指的是JavaScript中的一个函数，可以用来运行字符串中的JavaScript代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token string">'console.log(123)'</span>
<span class="token function">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
</code></pre></div><p>evel模式下每个模块都被包裹在一个evel函数中，函数末尾都会添加一个<code>//# sourceURL=xxxxx</code>的内容声明模块对应的源文件路径，实际并没有生成sourcemap文件，因此只能定位到错误的源文件，不能定位到实际行列</p> <ul><li>开发环境中
选择<code>eval-cheap-module-dource-map</code> <ol><li>框架经过Loader转换后差别很大，<code>module</code>调试的是Loader转换前的源代码</li> <li><code>cheap</code>只展示错误的行不展示列，省略列信息可以提升构建速度</li> <li>虽然启动打包会比较慢，但是如果使用了<code>webpack-dev-server</code>，其是在监视模式下重新打包，它重新打包的速度非常快</li></ol></li> <li>生产环境中
一般使用<code>none</code>模式，防止暴露源代码到生产环境，如果实在想定位，可以使用<code>nosources-source-map</code>，这样出现错误可以定位到源代码位置，也不至于暴露源代码</li></ul> <p>Webpack内部会对SourceMap内容判断来选择使用什么插件</p> <div class="language-js extra-class"><pre class="language-js"><code>webpack<span class="token operator">/</span>lib<span class="token operator">/</span>WebpackOptionsApply<span class="token punctuation">.</span>js<span class="token operator">:</span><span class="token number">232</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;source-map&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hidden <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;hidden&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> inline <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;inline&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> evalWrapped <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;eval&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cheap <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;cheap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> moduleMaps <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;module&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> noSources <span class="token operator">=</span> options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;nosources&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> Plugin <span class="token operator">=</span> evalWrapped
    <span class="token operator">?</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./EvalSourceMapDevToolPlugin&quot;</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./SourceMapDevToolPlugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token class-name">Plugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    filename<span class="token operator">:</span> inline <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>sourceMapFilename<span class="token punctuation">,</span>
    moduleFilenameTemplate<span class="token operator">:</span> options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>devtoolModuleFilenameTemplate<span class="token punctuation">,</span>
    fallbackModuleFilenameTemplate<span class="token operator">:</span>
    options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>devtoolFallbackModuleFilenameTemplate<span class="token punctuation">,</span>
    append<span class="token operator">:</span> hidden <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> moduleMaps <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> cheap <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    columns<span class="token operator">:</span> cheap <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    noSources<span class="token operator">:</span> noSources<span class="token punctuation">,</span>
    namespace<span class="token operator">:</span> options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>devtoolNamespace
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>devtool<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&quot;eval&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> EvalDevToolModulePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./EvalDevToolModulePlugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token class-name">EvalDevToolModulePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    moduleFilenameTemplate<span class="token operator">:</span> options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>devtoolModuleFilenameTemplate<span class="token punctuation">,</span>
    namespace<span class="token operator">:</span> options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>devtoolNamespace
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因此我们其实可以主动使用这些插件配置设置sourcemap</p> <div class="language-js extra-class"><pre class="language-js"><code>devtool<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>EvalSourceMapDevToolPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    exclude<span class="token operator">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    columns<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div><h2 id="webpack高级特性"><a href="#webpack高级特性" class="header-anchor">#</a> Webpack高级特性</h2> <h3 id="code-spliting"><a href="#code-spliting" class="header-anchor">#</a> Code Spliting</h3> <p>Code Spliting通过把项目中的资源模块按照我们设计的规则打包，<strong>降低应用的启动成本，提高响应速度</strong>
Webpack实现分包的方式主要有两种：</p> <ul><li>根据业务不同配置多个打包入口，输出多个打包结果
<ul><li>一般是传统的多页面应用程序，一个页面对应一个打包入口<div class="language-js extra-class"><pre class="language-js"><code>entry<span class="token operator">:</span><span class="token punctuation">{</span>
  index<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> <span class="token string">'index.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  other<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> <span class="token string">'other.js'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
output<span class="token operator">:</span><span class="token punctuation">{</span>
  filename<span class="token operator">:</span> <span class="token string">'[name].bundle.js'</span> <span class="token comment">//因为多模块所以第一部分用入口内部的name命名区分</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">'Multi Entry'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token string">'./src/index.html'</span><span class="token punctuation">,</span>
    scriptLoading<span class="token operator">:</span> <span class="token string">'blocking'</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>
    chunks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">]</span> <span class="token comment">// 指定使用index.bundle.js</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">'Multi Entry'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token string">'./src/other.html'</span><span class="token punctuation">,</span>
    scriptLoading<span class="token operator">:</span> <span class="token string">'blocking'</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'other.html'</span><span class="token punctuation">,</span>
    chunks<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'other'</span><span class="token punctuation">]</span> <span class="token comment">// 指定使用other.bundle.js</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div></li> <li>对于不同页面间公共的部分，提取到公共的结果中<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ...一些配置</span>
optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
  splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自动提取所有公共模块到单独bundle</span>
    chunks<span class="token operator">:</span> <span class="token string">'all'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li>结合ESM的动态导入特性，按需加载模块
按需加载指的是在应用运行过程中，需要某个资源模块时，才去加载这个模块，极大地降低应用启动时需要加载的资源体积，提高了应用的响应速度，同时也节省了带宽和流量<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span><span class="token punctuation">(</span>xxx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 继续处理</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 还可以通过webpack魔法注释给bundle起名字 webpackChunkName: &lt;chunk-name&gt; 如果name相同的话，文件会被打包到一个bundle中</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: 'index'*/</span> <span class="token string">'./index'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 继续处理</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h3 id="tree-shaking"><a href="#tree-shaking" class="header-anchor">#</a> Tree Shaking</h3> <p>Tree-shaking并不是指Webpack中的某一个配置选项，而是一组功能搭配使用过后实现的效果，这组功能在生产环境下都会自动启用（Webpack4+），所以使用生产模式打包就会有Tree-shaking的效果
在其他模式下启用Tree-shaking功能:</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...其他配置项</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 模块只导出被使用的成员</span>
    usedExports<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 压缩输出结果</span>
    minimize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 尽可能合并每一个模块到一个函数中</span>
    concatenateModules<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="sideeffects"><a href="#sideeffects" class="header-anchor">#</a> sideEffects</h3> <p>模块的副作用指的就是模块执行的时候除了导出成员，是否还做了其他的事情</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// button.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'this is button module'</span><span class="token punctuation">)</span> <span class="token comment">// 副作用代码</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">button</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 如果此时对button模块使用Tree-shaking模式 导出的内容会被移除，但是副作用代码还存在</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...其他配置项</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 清除被Tree-shaking后模块留下的副作用代码</span>
    sideEffects<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ...一些配置</span>
  <span class="token string">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// false就是告诉webpack没有副作用代码。webpack 在编译就会去读取这个 sideEffects 字段，如果有的话，它就会将所有引用这个包的副作用代码或者自身具有副作用的业务代码给去除掉。</span>
<span class="token punctuation">}</span>

<span class="token comment">// or</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ...一些配置</span>
  <span class="token comment">// sideEffects数组表示除了写明的模块需要保留副作用 其它的模块没有副作用</span>
  <span class="token string">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;./src/extend.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;*.css&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="优化webpack的构建速度和打包结果"><a href="#优化webpack的构建速度和打包结果" class="header-anchor">#</a> 优化Webpack的构建速度和打包结果</h2> <ol><li>配置不同环境的文件，通过<code>webpack-merge</code>库，合并不同的配置文件</li> <li>生产模式下的优化插件
<ol><li><code>webpack.DefinePlugin</code></li> <li><code>mini-css-extract-plugin</code>抽离css文件之后通过link引入，在loader和plugin中都需要处理下<div class="language-js extra-class"><pre class="language-js"><code>  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token comment">// 'style-loader', // 将样式通过 style 标签注入</span>
          MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>
          <span class="token string">'css-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
</code></pre></div></li> <li><code>optimize-css-assets-webpack-plugin</code>是webpack5以下的CSS压缩插件，webpack5及以上版本用<code>css-minimizer-webpack-plugin</code>，作为插件可以直接放到plugin中使用，但是这样会让压缩插件在任何时间都会使用，因此webpack建议在minimizer中使用，通过minimize特效统一管理。<div class="language-js extra-class"><pre class="language-js"><code>optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
  minimize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 配置是否开启压缩特效的 生产环境默认是true 开发环境默认是false</span>
  minimizer<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">CssMinimizerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol>
不过在minimizer中只配置一个CSS压缩插件，会覆盖掉webpack的默认压缩，导致JS代码不会压缩，需要再引入一个JS压缩插件<code>terser-webpack-plugin</code>，同样在minimizer中引入。<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack4以上可以使用'...'展开默认的压缩配置，无需再担心覆盖问题</span>
minimizer<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">CssMinimizerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'...'</span>
<span class="token punctuation">]</span>
</code></pre></div></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mo/webpack/Base.html" class="prev">
        webpack
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mo/assets/js/app.c4ede032.js" defer></script><script src="/mo/assets/js/2.3f89376a.js" defer></script><script src="/mo/assets/js/32.5a8bac30.js" defer></script>
  </body>
</html>
